@using Tiamat.Core.Services.Interfaces
@inject IAccountService accountService
@using System.Security.Claims

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.3/cyborg/bootstrap.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" />
    <link rel="stylesheet" href="~/css/customstyle.css" />
    <link rel="stylesheet" href="~/css/dashboardstyle.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
          integrity="sha512-..."
          crossorigin="anonymous"
          referrerpolicy="no-referrer" />
</head>
<body class="d-flex flex-column min-vh-100 text-white">
    @{
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
        var currentAction = ViewContext.RouteData.Values["action"]?.ToString();

        Guid? userId = null;
        var userIdString = User.FindFirstValue(ClaimTypes.NameIdentifier);
        if (!string.IsNullOrEmpty(userIdString))
        {
            userId = Guid.Parse(userIdString);
        }

        var activeAccountsCount = 0;
        if (userId.HasValue)
        {
            activeAccountsCount = accountService.GetActiveAccountsPerUserId(userId.Value);
        }

        var userName = User.Identity?.Name;
        var userRole = User.FindFirstValue(ClaimTypes.Role);
        if (string.IsNullOrEmpty(userRole))
        {
            userRole = "No Role";
        }
    }

    <div class="container-fluid">
        <div class="row flex-nowrap">
            <nav class="bg-dark d-flex flex-column align-items-start justify-content-between
                       border-end border-secondary sidebar">
                <div class="text-center mb-3" style="width:100%;">
                    <a asp-controller="Home" asp-action="Index" id="logo">
                        <img src="~/images/tiamat_logo.png" alt="Tiamat Logo" height="40" />
                        <div class="sidebar-text" style="font-weight:600; margin-top:0.6rem;">
                            Tiamat Fund
                        </div>
                    </a>
                </div>

                <ul class="nav flex-column w-100" style="gap: 0.6rem;">
                    <li class="nav-item custom-nav-item @(currentController == "User" && currentAction == "Dashboard" ? "active" : "")">
                        <a class="nav-link"
                           asp-controller="User"
                           asp-action="Dashboard"
                           id="home-link">
                            <i class="bi bi-speedometer2"></i>
                            <span class="sidebar-text">Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item custom-nav-item @(currentController == "User" && currentAction == "AccountCenter" ? "active" : "")">
                        <a class="nav-link"
                           asp-controller="User"
                           asp-action="AccountCenter"
                           id="about-link">
                            <i class="bi bi-person-circle"></i>
                            <span class="sidebar-text">Account Center</span>
                        </a>
                    </li>
                    <li class="nav-item custom-nav-item @(currentController == "User" && currentAction == "Settings" ? "active" : "")">
                        <a class="nav-link"
                           asp-controller="User"
                           asp-action="Settings"
                           id="settings-link">
                            <i class="bi bi-gear"></i>
                            <span class="sidebar-text">Settings</span>
                        </a>
                    </li>

                    @if (userRole == "admin")
                    {
                        <li class="nav-item custom-nav-item @(currentController == "Admin" && currentAction == "Panel" ? "active" : "")">
                            <a class="nav-link"
                               asp-controller="User"
                               asp-action="AdminPanel"
                               id="admin-link">
                                <i class="bi bi-shield-lock"></i>
                                <span class="sidebar-text">Admin Panel</span>
                            </a>
                        </li>
                    }
                </ul>

                <ul class="nav flex-column w-100 mt-3" style="gap: 0.6rem;">
                    <li class="nav-item custom-nav-item">
                        <form asp-controller="User" asp-action="Logout" method="post" class="m-0">
                            @Html.AntiForgeryToken()

                            <button type="submit" class="btn nav-link p-0" style="border: none; background: none;">
                                <i class="bi bi-box-arrow-right"></i>
                                <span class="sidebar-text">Log Out</span>
                            </button>
                        </form>
                    </li>
                </ul>

                <div class="sidebar-footer">
                    © 2025 - Tiamat.WebApp -
                    <a href="#" class="text-white">Privacy</a>
                </div>
            </nav>

            <div class="col px-0">
                <div class="d-flex justify-content-evenly align-items-center p-2 bg-dark text-white border-bottom border-secondary">
                    <span>Active Accounts: @activeAccountsCount</span>
                    <span>Weekly Change: []</span>

                    <span>
                        @userName
                        <sub class="ms-1 text-info" style="font-size:0.8rem">
                            (@userRole)
                        </sub>
                    </span>
                </div>
                <main class="p-4">
                    @RenderBody()
                </main>
            </div>
        </div>
    </div>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const navbarLinks = document.querySelectorAll(".nav-link");
            navbarLinks.forEach(link => {
                link.addEventListener("mousedown", function () {
                    this.style.transform = "scale(0.97)";
                });
                link.addEventListener("mouseup", function () {
                    this.style.transform = "";
                });
            });
        });
    </script>

    @RenderSection("Scripts", required: false)
</body>
</html>
