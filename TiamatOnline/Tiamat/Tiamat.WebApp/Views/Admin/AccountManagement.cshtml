@model IEnumerable<Tiamat.Models.Account>
@{
    Layout = "~/Views/Shared/_LayoutDashboard.cshtml";
    ViewData["Title"] = "Управление на акаунти";
}

@functions {
    string GetStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "active" => "status-active",
            "pending" => "status-pending",
            "failed" or "closed" => "status-red",
            _ => ""
        };
    }
    
    bool CanResetHwid(DateTime? lastUpdatedAt)
    {
        if (!lastUpdatedAt.HasValue) return true;
        return (DateTime.UtcNow - lastUpdatedAt.Value).TotalDays >= 7;
    }
}

<style>
    :root {
        --primary-color: #4361ee;
        --primary-hover: #3a56d4;
        --secondary-color: #7209b7;
        --bg-gradient: linear-gradient(135deg, #4361ee, #7209b7);
        --text-color: #ffffff;
        --light-text: #f8f9fa;
        --card-bg: rgba(28, 28, 30, 0.95);
        --input-bg: rgba(40, 40, 45, 0.9);
        --shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        --border-radius: 12px;
        --transition: all 0.3s ease;
        --dark-bg: #121212;
        --darker-bg: #0a0a0a;
    }

    #particles-js {
        position: fixed !important;
        width: 100% !important;
        height: 100% !important;
        top: 0 !important;
        left: 0 !important;
        z-index: -1 !important;
    }

    .account-list-container {
        max-width: 1440px;
        margin: 2rem auto;
        padding: 0 2rem;
        animation: fadeIn 0.8s ease-out;
    }

    .btn-hwid-reset {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
        color: white;
    }

    .btn-hwid-reset:disabled {
        background: #6c757d;
        cursor: not-allowed;
    }

    .hwid-info {
        font-size: 0.85rem;
        color: #ffc107;
    }

    .reset-countdown {
        font-size: 0.85rem;
        color: #ff4757;
    }
</style>

<div id="particles-js"></div>

<div class="account-list-container">
    <h1 class="list-title">Управление на акаунти</h1>

    <div class="accounts-card">
        <div class="accounts-card-header">
            <h2><i class="bi bi-safe2 me-2"></i>Активни акаунти</h2>
            <button class="btn-secondary" id="refreshButton">
                <i class="bi bi-arrow-repeat me-2"></i>Обнови
            </button>
        </div>

        <div class="accounts-card-body">
            @if (!Model.Any())
            {
                <div class="no-accounts">
                    <i class="bi bi-search mb-3" style="font-size: 2rem; opacity: 0.5; display: block;"></i>
                    Няма намерени активни акаунти.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="account-table">
                        <thead>
                            <tr>
                                <th><i class="bi bi-person-badge me-2"></i>Име</th>
                                <th><i class="bi bi-server me-2"></i>Платформа</th>
                                <th><i class="bi bi-cpu me-2"></i>HWID</th>
                                <th><i class="bi bi-hdd-network me-2"></i>VPS</th>
                                <th><i class="bi bi-cash-stack me-2"></i>Капитал</th>
                                <th><i class="bi bi-clock me-2"></i>Последно обновяване HWID</th>
                                <th class="action-cell"><i class="bi bi-tools me-2"></i>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var account in Model.Where(a => a.Status == Tiamat.Models.AccountStatus.Active))
                            {
                                <tr>
                                    <td>@account.AccountName</td>
                                    <td>@account.Platform</td>
                                    <td>
                                        @if(!string.IsNullOrEmpty(account.Affiliated_HWID))
                                        {
                                            <span>@account.Affiliated_HWID</span>
                                        }
                                        else
                                        {
                                            <span class="hwid-info"><i class="bi bi-exclamation-triangle me-1"></i>Няма HWID</span>
                                        }
                                    </td>
                                    <td>@account.VPSName</td>
                                    <td>@account.CurrentCapital.ToString("C")</td>
                                    <td>
                                        @if(account.LastUpdatedAt.HasValue)
                                        {
                                            <span>@account.LastUpdatedAt.Value.ToShortDateString()</span>
                                            <div class="@(CanResetHwid(account.LastUpdatedAt) ? "hwid-info" : "reset-countdown")">
                                                @if(CanResetHwid(account.LastUpdatedAt))
                                                {
                                                    <i class="bi bi-check-circle me-1"></i>@("Може да се смени")
                                                }
                                                else
                                                {
                                                    var days = Math.Max(0, 7 - (DateTime.UtcNow - account.LastUpdatedAt.Value).TotalDays);
                                                    <i class="bi bi-clock me-1"></i>@($"Остават {days:F0} дни")
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="hwid-info"><i class="bi bi-info-circle me-1"></i>Никога</span>
                                        }
                                    </td>
                                    <td class="action-cell">
                                        <button type="button"
                                                class="btn-action btn-hwid-reset @(CanResetHwid(account.LastUpdatedAt) ? "" : "disabled")"
                                                data-bs-toggle="modal"
                                                data-bs-target="#resetHwidModal"
                                                data-bs-accountid="@account.Id"
                                                data-bs-accountname="@account.AccountName"
                                                @(CanResetHwid(account.LastUpdatedAt) ? "" : "disabled")>
                                            <i class="bi bi-arrow-clockwise me-1"></i>Смени HWID
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Reset HWID Modal -->
<div class="modal fade" id="resetHwidModal" tabindex="-1" aria-labelledby="resetHwidModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resetHwidModalLabel"><i class="bi bi-cpu me-2"></i>Смяна на HWID</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="resetHwidForm" asp-action="ResetHwid" asp-controller="Admin" method="post">
                    <input type="hidden" name="accountId" id="resetAccountIdHidden" />
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Акаунт</label>
                        <input type="text" class="form-control" id="resetAccountName" readonly />
                    </div>

                    <div class="mb-3">
                        <label for="newHwid" class="form-label fw-bold"><i class="bi bi-key me-2"></i>Нов HWID</label>
                        <input type="text" class="form-control" id="newHwid" name="newHwid" placeholder="Въведете нов HWID..." required />
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i><strong>Внимание:</strong> HWID може да се сменя само веднъж на седмица!
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x me-1"></i>Отказ
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check me-1"></i>Потвърди
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            particlesJS('particles-js', {
                "particles": {
                    "number": {
                        "value": 80,
                        "density": {
                            "enable": true,
                            "value_area": 800
                        }
                    },
                    "color": {
                        "value": "#4361ee"
                    },
                    "shape": {
                        "type": "circle",
                        "stroke": {
                            "width": 0,
                            "color": "#000000"
                        },
                        "polygon": {
                            "nb_sides": 5
                        }
                    },
                    "opacity": {
                        "value": 0.5,
                        "random": false,
                        "anim": {
                            "enable": false,
                            "speed": 1,
                            "opacity_min": 0.1,
                            "sync": false
                        }
                    },
                    "size": {
                        "value": 3,
                        "random": true,
                        "anim": {
                            "enable": false,
                            "speed": 40,
                            "size_min": 0.1,
                            "sync": false
                        }
                    },
                    "line_linked": {
                        "enable": true,
                        "distance": 150,
                        "color": "#7209b7",
                        "opacity": 0.4,
                        "width": 1
                    },
                    "move": {
                        "enable": true,
                        "speed": 2,
                        "direction": "none",
                        "random": false,
                        "straight": false,
                        "out_mode": "out",
                        "bounce": false,
                        "attract": {
                            "enable": false,
                            "rotateX": 600,
                            "rotateY": 1200
                        }
                    }
                },
                "interactivity": {
                    "detect_on": "canvas",
                    "events": {
                        "onhover": {
                            "enable": true,
                            "mode": "grab"
                        },
                        "onclick": {
                            "enable": true,
                            "mode": "push"
                        },
                        "resize": true
                    },
                    "modes": {
                        "grab": {
                            "distance": 140,
                            "line_linked": {
                                "opacity": 1
                            }
                        },
                        "bubble": {
                            "distance": 400,
                            "size": 40,
                            "duration": 2,
                            "opacity": 8,
                            "speed": 3
                        },
                        "repulse": {
                            "distance": 200,
                            "duration": 0.4
                        },
                        "push": {
                            "particles_nb": 4
                        },
                        "remove": {
                            "particles_nb": 2
                        }
                    }
                },
                "retina_detect": true
            });

            var resetHwidModal = document.getElementById('resetHwidModal');
            resetHwidModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var accountId = button.getAttribute('data-bs-accountid');
                var accountName = button.getAttribute('data-bs-accountname');
                document.getElementById('resetAccountIdHidden').value = accountId;
                document.getElementById('resetAccountName').value = accountName;
                document.getElementById('newHwid').value = "";
            });

            document.getElementById('refreshButton').addEventListener('click', function() {
                window.location.reload();
            });
        });
    </script>

    @Html.Partial("_IziToastPartial")
}
